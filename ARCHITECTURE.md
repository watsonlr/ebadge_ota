# System Architecture Diagrams

## Boot Flow Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                        Power On / Reset                         │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│              ROM Bootloader (in ESP32-S3 silicon)               │
│  • Permanent, cannot be changed                                 │
│  • Listens for UART download mode (BOOT button)                 │
│  • Loads 2nd stage bootloader from 0x1000                       │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│           ESP-IDF Bootloader (bootloader.bin @ 0x1000)          │
│  • Reads partition table                                        │
│  • Reads OTA data to find boot partition                        │
│  • Verifies app image integrity                                 │
│  • Jumps to selected app partition                              │
└────────────────────────────┬────────────────────────────────────┘
                             │
                ┌────────────┴───────────────┐
                │                            │
                ▼                            ▼
┌──────────────────────────┐    ┌──────────────────────────┐
│   Factory Partition      │    │   OTA Partition          │
│   (Loader App)           │    │   (Downloaded App)       │
│                          │    │                          │
│  ┌────────────────────┐  │    │  ┌────────────────────┐  │
│  │ Check BOOT button  │  │    │  │   User App Code    │  │
│  │ USB Recovery?      │  │    │  │   (LED, Sensor,    │  │
│  └─────────┬──────────┘  │    │  │    Weather, etc.)  │  │
│            │              │    │  └────────────────────┘  │
│            ▼              │    │                          │
│  ┌────────────────────┐  │    │  Can call:               │
│  │ Connect Wi-Fi      │  │    │  esp_ota_set_boot_       │
│  └─────────┬──────────┘  │    │  partition(factory)      │
│            │              │    │  to return to loader     │
│            ▼              │    │                          │
│  ┌────────────────────┐  │    └──────────────────────────┘
│  │ Fetch Manifest     │  │
│  └─────────┬──────────┘  │
│            │              │
│            ▼              │
│  ┌────────────────────┐  │
│  │ Show App Menu      │  │
│  └─────────┬──────────┘  │
│            │              │
│            ▼              │
│  ┌────────────────────┐  │
│  │ Download OTA App   │  │
│  └─────────┬──────────┘  │
│            │              │
│            ▼              │
│  ┌────────────────────┐  │
│  │ Flash to OTA slot  │  │
│  └─────────┬──────────┘  │
│            │              │
│            ▼              │
│  ┌────────────────────┐  │
│  │ Set boot partition │  │
│  └─────────┬──────────┘  │
│            │              │
│            ▼              │
│       esp_restart()       │
└──────────────────────────┘
```

## Flash Memory Layout

```
Flash Address    Size      Partition         Type        Purpose
═══════════════════════════════════════════════════════════════════
0x0000           4KB       (Reserved)        -           2nd bootloader vectors
0x1000          ~40KB      bootloader        bootloader  ESP-IDF 2nd stage bootloader
                                                         ↑ Can be reflashed via USB
───────────────────────────────────────────────────────────────────
0x8000           4KB       partition table   data        Partition layout definition
0x9000          24KB       nvs               data        Wi-Fi credentials, settings
0xF000           8KB       otadata           data        OTA partition state
───────────────────────────────────────────────────────────────────
0x10000          1MB       loader            app         YOUR PERMANENT LOADER
                                             (factory)   ✓ Never overwritten by OTA
                                                        ✓ Always available for recovery
───────────────────────────────────────────────────────────────────
0x110000         1MB       app_0             app         Downloadable app slot 0
                                             (ota_0)     ↔ Switchable
───────────────────────────────────────────────────────────────────
0x210000         1MB       app_1             app         Downloadable app slot 1
                                             (ota_1)     ↔ Switchable
───────────────────────────────────────────────────────────────────
0x310000         1MB       spiffs            data        File storage
                                                        (certs, configs, etc.)
═══════════════════════════════════════════════════════════════════
Total: 4MB Flash
```

## OTA Download Flow

```
┌─────────────┐
│  ESP32-S3   │
│   Loader    │
└──────┬──────┘
       │
       │ 1. HTTP GET manifest.json
       ▼
┌──────────────────────────────────────────┐
│         Web Server / OTA Server          │
│  ┌────────────────────────────────────┐  │
│  │  manifest.json                     │  │
│  │  {                                 │  │
│  │    "apps": [                       │  │
│  │      {                             │  │
│  │        "name": "LED Controller",   │  │
│  │        "version": "1.0.0",         │  │
│  │        "url": "http://.../led.bin" │  │
│  │      }                             │  │
│  │    ]                               │  │
│  │  }                                 │  │
│  └────────────────────────────────────┘  │
└──────────────┬───────────────────────────┘
               │ 2. Response: JSON
┌──────────────┴──────┐
│     ESP32-S3        │
│  Parse JSON         │
│  Display app list   │
│  User selects app   │
└──────────┬──────────┘
           │ 3. HTTP GET led.bin
           ▼
┌──────────────────────────────────────────┐
│         Web Server / OTA Server          │
│  ┌────────────────────────────────────┐  │
│  │  apps/led.bin                      │  │
│  │  [Binary firmware data...]         │  │
│  └────────────────────────────────────┘  │
└──────────────┬───────────────────────────┘
               │ 4. Response: Binary stream
┌──────────────┴──────────────┐
│         ESP32-S3            │
│  ┌───────────────────────┐  │
│  │ esp_https_ota_begin() │  │
│  └──────────┬────────────┘  │
│             │                │
│  ┌──────────▼────────────┐  │
│  │ Read chunks          │  │
│  │ Write to OTA         │  │
│  │ partition (ota_0)    │  │
│  └──────────┬────────────┘  │
│             │                │
│  ┌──────────▼────────────┐  │
│  │ esp_https_ota_end()  │  │
│  │ Verify image         │  │
│  └──────────┬────────────┘  │
│             │                │
│  ┌──────────▼────────────┐  │
│  │ Set boot partition   │  │
│  │ to ota_0             │  │
│  └──────────┬────────────┘  │
│             │                │
│  ┌──────────▼────────────┐  │
│  │   esp_restart()      │  │
│  └──────────────────────┘  │
└─────────────────────────────┘
               │
               ▼
      ┌────────────────┐
      │  Reboot into   │
      │  Downloaded    │
      │     App!       │
      └────────────────┘
```

## USB Recovery Mode Flow (When Fully Implemented)

```
┌─────────────────────────────────────────────────────────────────┐
│              User holds BOOT button during reset                │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│              Loader detects BOOT button pressed                 │
│              usb_recovery_check_trigger() → true                │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│              Initialize USB Host stack                          │
│              usb_host_install()                                 │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│              Wait for USB flash drive connection                │
│              msc_host_install()                                 │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│              Mount FAT filesystem from USB                      │
│              esp_vfs_fat_rawflash_mount("/usb", ...)            │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│              Look for /usb/bootloader.bin                       │
│              FILE *f = fopen("/usb/bootloader.bin", "rb");      │
└────────────────────────────┬────────────────────────────────────┘
                             │
                 ┌───────────┴───────────┐
                 │                       │
            Not Found                 Found
                 │                       │
                 ▼                       ▼
        ┌────────────────┐    ┌────────────────────────┐
        │  Error message │    │  Read file into buffer │
        │  Exit recovery │    └──────────┬─────────────┘
        └────────────────┘               │
                                         ▼
                              ┌─────────────────────────┐
                              │  Verify file size       │
                              │  (< 64KB)               │
                              └──────────┬──────────────┘
                                         │
                                         ▼
                              ┌─────────────────────────┐
                              │  TODO: Verify SHA256    │
                              └──────────┬──────────────┘
                                         │
                                         ▼
                              ┌─────────────────────────┐
                              │  Erase flash @ 0x1000   │
                              │  esp_flash_erase_region │
                              └──────────┬──────────────┘
                                         │
                                         ▼
                              ┌─────────────────────────┐
                              │  Write new bootloader   │
                              │  esp_flash_write()      │
                              └──────────┬──────────────┘
                                         │
                                         ▼
                              ┌─────────────────────────┐
                              │  Success message        │
                              │  esp_restart()          │
                              └─────────────────────────┘
```

## Component Interaction Diagram

```
┌──────────────────────────────────────────────────────────────────┐
│                      ota_loader_main.c                           │
│                    (Main Application)                            │
└───┬──────────────┬──────────────┬──────────────┬────────────────┘
    │              │              │              │
    │              │              │              │
    ▼              ▼              ▼              ▼
┌─────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐
│  Wi-Fi  │  │   OTA    │  │   USB    │  │   ESP-IDF    │
│ Manager │  │ Manager  │  │ Recovery │  │   System     │
└────┬────┘  └────┬─────┘  └────┬─────┘  └──────┬───────┘
     │            │             │               │
     │            │             │               │
     ▼            ▼             ▼               ▼
┌─────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐
│esp_wifi │  │esp_http_ │  │usb_host  │  │  nvs_flash   │
│esp_event│  │  client  │  │msc_host  │  │esp_partition │
│         │  │esp_https_│  │esp_vfs_  │  │  esp_ota_ops │
│         │  │   ota    │  │  fat     │  │              │
│         │  │  cJSON   │  │esp_flash │  │              │
└─────────┘  └──────────┘  └──────────┘  └──────────────┘
```

## Typical Development Workflow

```
┌──────────────────────────────────────────────────────────────────┐
│  Step 1: Build and Flash Loader (One Time)                      │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  $ idf.py build                                            │ │
│  │  $ idf.py -p COM3 erase-flash                              │ │
│  │  $ idf.py -p COM3 flash monitor                            │ │
│  └────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  Step 2: Set Up OTA Server                                      │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  $ python3 simple_ota_server.py                            │ │
│  │  Server running at http://192.168.1.100:8080               │ │
│  └────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  Step 3: Build Your App                                         │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  $ cd my_app                                               │ │
│  │  $ idf.py build                                            │ │
│  │  $ cp build/my_app.bin ../ota_files/apps/                 │ │
│  └────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  Step 4: Update Manifest                                        │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  Edit ota_files/manifest.json                              │ │
│  │  Add your app's name, version, URL                         │ │
│  └────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  Step 5: Download via ESP32 Loader                              │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  [Menu] → 2. Download and install an app                  │ │
│  │  Select app number                                         │ │
│  │  Wait for download...                                      │ │
│  │  ESP32 reboots into your app!                              │ │
│  └────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  Step 6: Iterate!                                               │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  Modify app → rebuild → copy .bin → download again         │ │
│  │  No USB cable needed after initial loader flash!           │ │
│  └────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```
